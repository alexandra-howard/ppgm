---
title: "How to use PPGM"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to use PPGM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
# Load the package and dependencies
library(ppgm)
```

PaleoPhyloGeographic Models (PPGM) are a useful way to incorporate paleontological data into analysis of climatic niche shifts in modern taxa.

Here we will walk you through the basic steps of the PPGM workflow, using the included data within the package.

## Input Data

Three things are needed to run a PPGM. Species occurrences, a **dated** phylogenetic tree, and paleoclimate data. Fossils are optional but highly recommended.

There are many sources for species occurrences, which will depend on your specific analysis. For instructions on how to find and clean extant species occurrence data, please see this [webpage](https://lawinglab.org/ppgm/).

### Extant Data

We are using the *Sceloporus* data included in the package. This data was first collected for Lawing et al (2016).

After loading the package, you can load the data using the `data` function

```{r load occurrence data}
# load Sceloporus occurrence data
data(occurrences)
```

This file contains *Sceloporus* occurrences for 53 species, Longitude and Latitude for each occurrence point, and all 19 bioclimatic variables for each of these points.

Only the first 3 columns are required for PPGM to run, as there is code that extracts bioclimate variables from the first layer of paleoclimate data. If the bioclimatic variables are included in the input dataset, then the package will default to estimating climate envelopes using these variables, rather than the paleoclimate data.

All 19 bioclimatic variables must be included if including any bioclimatic variables at this stage. If some variables are known, the columns may be left blank

```{r view occurrence}
# View the occurrence data to check all in order
head(occurrences,n=3)
```

### Phylogenetic Trees

PPGM requires **dated** phylogenetic trees. This is so that the code can associate ages of nodes with appropriate paleoclimate layers.

A sample of the Leache & Sites (2010) phylogenetic trees, trimmed for *Sceloporus* analysis by Lawing et al (2016), is included in the package. For the current analysis in the vignette we will use a subset of this dataset, in order to save computational time.

These trees can be accessed using the `data` function.

We will store 10 trees in the variable `vigtrees` for this analysis to save on computational time. A larger number of phylogenies will increase computational time. We recommend using the inbuilt parallel function to speed large analyses up, see later.

```{r load trees}
# Load the Sceloporus phylogenies and select only 10
data(sampletrees)
vigtrees <- sample(sampletrees, size=10)
```

### Paleoclimate Data

We include a sample paleoclimate dataset within the package. This is a dataset

### Fossil Data

We will also use the *Sceloporus* fossil dataset collected for Lawing et al (2016), representing a sampling of fossils from the literature. This dataset includes 45 *Sceloporus* fossils identified to the genus level.

This dataset is included in the package, and can be accessed using:

```{r load fossils}
data("scel_fossils")
head(scel_fossils)
```

This dataset includes minimum and maximum age for each fossil, with longitude and latitude for each point.

Fossil data is in the format of a table. It is important that the ages are in the first two columns, not the name of the species as with the modern occurrences.

## Set Up Analysis

### Bounds

PPGM uses phylogenetic comparative techniques to estimate climatic envelopes through time. Setting appropriate bounds is an important step. When no bounds are included, `ppgm` will use the default bounds from the `fitContinuous` function, which is likely not appropriate for analysis of climate niche.

Here we will set up a reasonable bounds for this analysis, using bioclimatic variable 1 (Mean Annual Temperature)

First we can look at the summary of bio1 in the occurrences dataset, using `getBioclimVars`.

```{r examine bio1}
bio1occ <- getBioclimVars(occurrences = occurrences, which.biovars=1)
summary(bio1occ$bio1)
```

The minimum Mean Annual Temperature gets is -29 , and the max is 291, so we can use these values to give an idea for the bounds.

NOTE: If using multiple variables, you should use the bounds for the largest number. For example, seasonality:

```{r examine bio4}
bio4occ <- getBioclimVars(occurrences = occurrences, which.biovars=4)
summary(bio4occ$bio4)

```

PPGM will use the same bounds for all biovariables, so make sure to set bounds accordingly.

Here we will set bounds for the bio1 analysis for a Brownian Motion model.

```{r set BM bounds}
# Set bounds for Brownian Motion
bmbounds <- list(sigsq = c(min = 0, max = 1000))
```

And set bounds for the bio1 analysis for an Ornstein-Uhlenbeck model.

```{r set OU bounds}
# Set bounds for OU
oubounds <- list(sigsq = c(min = 0, max = 1000),alpha = c(min = 0, max = 1000))
```

### Control

Remember to also set a control. These are the settings used by `fitContinuous` to optimize the model likelihood.

```{r set control}
#set control for model
contr <- list(niter=20)
```

## Run PPGM

PPGMs can be run for a variety of models, and using either just present occurrences, or fossil and present occurrences. The 'present' is set by the youngest tips in the phylogeny - PPGMs run on extinct clades must take this into account.

### Many Trees - No Fossils - Brownian Motion

For this first run, we will show a ppgm run with 10 trees and no fossils.

We will use our previously made objects, `occurrences` and `vigtrees`.

To select biovariable 1 we use `which.biovars = 1`.

To select the Brownian Motion model we use `model = "BM"`.

To view results in the format of a TraitGram, we use the parameter `plot.TraitGram`.

To change the default name of the output (which defaults to bio[#]), we use `path = "BM"`.

```{r run ppgm 1 BM no fossils}
bio1ppgm_bm <- ppgm(occurrences, trees = vigtrees, bounds = bmbounds, control = contr, 
                    which.biovars = 1, model = "BM", plot.TraitGram = TRUE, path = "BM")

```

This should produce a figure in your working directory called "BMbio1.pdf".

Let's take a look at this figure.

```{r image-ppgm-nofossils-bm, echo = FALSE, message=FALSE, fig.align='center', fig.cap='Traitgram showing Mean Annual Temperature', out.width="75%", fig.pos='H'}
knitr::include_graphics("./BMbio1.pdf")
```

This is a traitgram for the mean annual temperature variable. The minimum is shown in grey, and the maximum in blue.

### Many Trees - No Fossils - Ornstein Uhlenbeck

Let's have a look at the outputs from another commonly used model, OU.

Remember that this model uses different bounds

```{r run ppgm 2 OU no fossils}
bio1ppgm_ou <- ppgm(occurrences, trees = vigtrees, bounds = oubounds, control = contr, 
                    which.biovars = 1, model = "OU", plot.TraitGram = TRUE, path = "OU")

```

```{r image-ppgm-nofossils-OU, echo = FALSE, message=FALSE, fig.align='center', fig.cap='Traitgram showing Mean Annual Temperature', out.width="75%", fig.pos='H'}
knitr::include_graphics("./OUbio1.pdf")
```

### PPGM results

The `ppgm` function produces a list of outputs that can be used separately with other functions in the package, or with further downstream analysis. Let's take a look at these.

#### Climate Envelope

```{r climate envelope output}
head(bio1ppgm_bm$cem)
```

The climate envelope for each species is stored in `cem`. This contains the minimum, mean, and max, for the biovariable used in the ppgm workflow. As we only included one biovariable (bio1), we have 3 columns

```{r climate envelope output2}
head(bio1ppgm_bm$envelope[[1]])
```

The output `envelope` is a list (of however many trees) containing the climate envelope of each node of the tree. This is used downstream in the function `getLineageClimate` and is the equivalent to the output of the function `getEnvelopes`.

#### Treedata

```{r}
#head(bio1ppgm_bm$treedata_min[[1]])
```

### Viewing climate envelope occupancy geographically - MESS

The traitgram results show how these individual bioclimatic variables change through time. To see how these relate to geographic space, we need to use MESS

MESS, multivariate environmental suitability surfaces
